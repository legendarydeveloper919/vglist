<% content_for :title, "GraphiQL" %>

<div id="graphiql-injection-point" style="height: 100vh; width: 100vw; margin: 0;"
     data-graphql-schema="<%= render plain: "#{render partial: 'static_pages/graphql_schema' }" %>"
></div>

<script src="<%= asset_pack_path 'graphiql.js' %>" type="application/javascript"></script>

<style>
  body {
    margin: 0;
    padding: 0;
  }
</style>

<%= javascript_tag nonce: true do %>
  let graphQLFetcher = (graphQLParams, opts = { headers: {} }) => {
    return fetch(window.location.origin + '/graphql', {
      method: 'post',
      headers: Object.assign({ 'Content-Type': 'application/json', 'User-Agent': 'vglist.co GraphiQL' }, opts.headers),
      body: JSON.stringify(graphQLParams),
    }).then(response => response.json());
  }

  let renderGraphiQL = async () => {
    let schema = document.getElementById("graphiql-injection-point").dataset.graphqlSchema;
    let graphQLSchema = buildSchema(schema);

    ReactDOM.render(
      React.createElement(GraphiQL, {
        schema: graphQLSchema,
        fetcher: graphQLFetcher,
        headerEditorEnabled: true,
        headers: '{\n  "X-User-Email": "foo@example.com",\n  "X-User-Token": "API_TOKEN_HERE"\n}'
      }),
      document.getElementById("graphiql-injection-point")
    );
  };

  renderGraphiQL();
<% end %>
